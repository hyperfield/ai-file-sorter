name: Build Windows Exe

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      # Global environment variables for sccache
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Enable GitHub Cache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      # 1. SETUP COMPILER CACHE (SCCACHE)
      # This saves the compiled C++ objects of YOUR code
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.3

      # 2. INSTALL QT (WITH CACHING ENABLED)
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          cache: 'true'  # <--- Added this line to cache Qt download

      - name: Install OpenBLAS & Add to Path
        shell: powershell
        run: |
          cmd /c "C:\msys64\usr\bin\pacman.exe -S --noconfirm mingw-w64-x86_64-openblas"
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # 3. CACHE VCPKG (DEPENDENCIES)
      # This saves the huge time it takes to compile curl, fmt, jsoncpp, etc.
      - name: Restore vcpkg Cache
        id: vcpkg-cache
        uses: actions/cache@v3
        with:
          path: vcpkg
          # Key includes the list of libs so it updates if you change them
          key: ${{ runner.os }}-vcpkg-lib-cache-curl-fmt-spdlog-jsoncpp-sqlite3

      - name: Setup Local vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          # Only clone if not restored from cache
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
          cd $env:GITHUB_WORKSPACE\vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install Support Libraries
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          cd $env:VCPKG_ROOT
          # vcpkg is smart; if files are cached, this finishes instantly
          .\vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

      - name: Build Llama Engine
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          # Added sccache to Llama build via CMAKE_CXX_COMPILER_LAUNCHER
          & app/scripts/build_llama_windows.ps1 `
            -cuda off `
            -vcpkgroot "$env:VCPKG_ROOT" `
            -openblasroot "C:\msys64\mingw64" `
            -extra_cmake_args "-DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache"

      - name: Locate and Stage Llama DLL
        shell: powershell
        run: |
          $dll = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "llama.dll" -Recurse | Select-Object -First 1
          if ($dll) {
              $destDir = "$env:GITHUB_WORKSPACE\build\Release"
              New-Item -ItemType Directory -Force -Path $destDir | Out-Null
              Copy-Item -Path $dll.FullName -Destination $destDir -Force
              Write-Host "Staged llama.dll to $destDir"
          } else {
              Write-Warning "llama.dll not found. The app might fail to run, but we will try to finish the build."
          }

      - name: Create Dummy Precompiled Folders
        shell: powershell
        run: |
          $paths = @(
            "app\lib\precompiled\cpu",
            "app\lib\precompiled\cuda",
            "app\lib\precompiled\vulkan"
          )
          foreach ($p in $paths) {
            $fullPath = Join-Path $env:GITHUB_WORKSPACE $p
            if (-not (Test-Path $fullPath)) {
              New-Item -Path $fullPath -ItemType Directory -Force
            }
          }

      - name: Configure CMake
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: >
          cmake -B build -S app 
          -DCMAKE_BUILD_TYPE=Release 
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" 
          -DVCPKG_TARGET_TRIPLET=x64-windows 
          -DWININET_LIB=wininet 
          -DCMAKE_C_COMPILER_LAUNCHER=sccache 
          -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build App
        run: cmake --build build --config Release

      - name: Bundle Files
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          mkdir output
          if exist build\Release\*.exe copy build\Release\*.exe output\
          if exist build\Release\llama.dll copy build\Release\llama.dll output\
          windeployqt --release --dir output output\*.exe
          copy "%VCPKG_ROOT%\installed\x64-windows\bin\*.dll" output\
          if exist C:\msys64\mingw64\bin\libopenblas*.dll copy C:\msys64\mingw64\bin\libopenblas*.dll output\
          if exist C:\msys64\mingw64\bin\libgfortran*.dll copy C:\msys64\mingw64\bin\libgfortran*.dll output\
          if exist C:\msys64\mingw64\bin\libgcc*.dll copy C:\msys64\mingw64\bin\libgcc*.dll output\
          if exist C:\msys64\mingw64\bin\libwinpthread*.dll copy C:\msys64\mingw64\bin\libwinpthread*.dll output\

      - name: Upload Finished App
        uses: actions/upload-artifact@v4
        with:
          name: AI-File-Sorter-Gemini
          path: output/*
