name: Build Windows Exe

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Enable GitHub Cache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      # 1. Install OpenBLAS via MSYS2 (Required for Llama CPU build)
      - name: Install OpenBLAS
        shell: cmd
        run: |
          C:\msys64\usr\bin\pacman.exe -S --noconfirm mingw-w64-x86_64-openblas

      - name: Setup Local vcpkg
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
          cd $env:GITHUB_WORKSPACE\vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install Support Libraries
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          cd $env:VCPKG_ROOT
          .\vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

      - name: Build Llama Engine
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          Write-Host "Using VCPKG_ROOT: $env:VCPKG_ROOT"
          # Run script pointing to our local vcpkg and the system MSYS2 OpenBLAS
          & app/scripts/build_llama_windows.ps1 -cuda off -vcpkgroot "$env:VCPKG_ROOT"

      - name: Configure CMake
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: >
          cmake -B build -S app 
          -DCMAKE_BUILD_TYPE=Release 
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" 
          -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Build App
        run: cmake --build build --config Release

      - name: Bundle Files
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          mkdir output
          rem Copy Main App
          copy build\Release\*.exe output\
          rem Copy Qt DLLs
          windeployqt --release --dir output output\*.exe
          rem Copy Library DLLs from vcpkg
          copy "%VCPKG_ROOT%\installed\x64-windows\bin\*.dll" output\
          rem Copy OpenBLAS DLLs (Critical for running the app)
          if exist C:\msys64\mingw64\bin\libopenblas*.dll copy C:\msys64\mingw64\bin\libopenblas*.dll output\
          if exist C:\msys64\mingw64\bin\libgfortran*.dll copy C:\msys64\mingw64\bin\libgfortran*.dll output\
          if exist C:\msys64\mingw64\bin\libgcc*.dll copy C:\msys64\mingw64\bin\libgcc*.dll output\
          if exist C:\msys64\mingw64\bin\libquadmath*.dll copy C:\msys64\mingw64\bin\libquadmath*.dll output\
          if exist C:\msys64\mingw64\bin\libwinpthread*.dll copy C:\msys64\mingw64\bin\libwinpthread*.dll output\

      - name: Upload Finished App
        uses: actions/upload-artifact@v4
        with:
          name: AI-File-Sorter-Gemini
          path: output/*
