name: Build Fixed Gemini
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    env:
      # Force vcpkg to use binary caching if available to speed up re-runs
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Export GitHub Actions Cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'

    - name: Install Libraries (Curl, etc)
      # We specify 'curl[ssl]' to ensure HTTPS works for Gemini
      # We force 'x64-windows' to match the Qt architecture
      run: vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

    - name: Configure CMake
      # FIXED: We added -DVCPKG_TARGET_TRIPLET=x64-windows
      # This tells CMake exactly which folder to look in for the libraries we just installed.
      run: >
        cmake -B build -S app 
        -DCMAKE_BUILD_TYPE=Release 
        -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" 
        -DVCPKG_TARGET_TRIPLET=x64-windows

    - name: Build App
      run: cmake --build build --config Release

    - name: Gather Files
      shell: cmd
      run: |
        mkdir output
        
        rem 1. Copy the Main EXE (Look in Release folder)
        copy build\Release\*.exe output\
        
        rem 2. Get Qt DLLs
        windeployqt --release --dir output output\*.exe
        
        rem 3. Get Library DLLs (Curl, etc)
        rem They live in vcpkg installed/bin. We copy them so the app opens.
        copy %VCPKG_INSTALLATION_ROOT%\installed\x64-windows\bin\*.dll output\

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AI-File-Sorter-Gemini-Final
        path: output/*
