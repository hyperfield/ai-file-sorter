steps:
 - name: Checkout Code
   uses: actions/checkout@v4
   with:
     submodules: recursive

 - name: Enable GitHub Cache
   uses: actions/github-script@v7
   with:
     script: |
       core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
       core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

 - name: Install Qt
   uses: jurplel/install-qt-action@v3
   with:
     version: '6.5.3'
     host: 'windows'
     target: 'desktop'
     arch: 'win64_msvc2019_64'

 - name: Setup Local vcpkg
   shell: powershell
   run: |
     # Clone vcpkg locally so we have write access
     git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
     cd $env:GITHUB_WORKSPACE\vcpkg
     .\bootstrap-vcpkg.bat

 - name: Install Support Libraries
   shell: powershell
   run: |
     # Use the LOCAL vcpkg to install libraries
     cd $env:GITHUB_WORKSPACE\vcpkg
     .\vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

 - name: Build Llama Engine (Required Dependency)
   shell: powershell
   run: |
     # Point the build script to our LOCAL vcpkg
     $vcpkgPath = "$env:GITHUB_WORKSPACE\vcpkg"
     
     powershell -ExecutionPolicy Bypass -File app/scripts/build_llama_windows.ps1 `
       -cuda off `
       -vcpkgroot $vcpkgPath

 - name: Configure CMake
   run: >
     cmake -B build -S app 
     -DCMAKE_BUILD_TYPE=Release 
     -DCMAKE_TOOLCHAIN_FILE="$env:GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake" 
     -DVCPKG_TARGET_TRIPLET=x64-windows

 - name: Build App
   run: cmake --build build --config Release

 - name: Bundle Files
   shell: cmd
   run: |
     mkdir output
     rem Copy Main App
     copy build\Release\*.exe output\
     rem Copy Qt DLLs
     windeployqt --release --dir output output\*.exe
     rem Copy Library DLLs from LOCAL vcpkg
     copy %GITHUB_WORKSPACE%\vcpkg\installed\x64-windows\bin\*.dll output\

 - name: Upload Finished App
   uses: actions/upload-artifact@v4
   with:
     name: AI-File-Sorter-Gemini
     path: output/*
