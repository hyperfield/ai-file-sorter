name: Build Windows Exe

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1  # ⚡ Faster Checkout

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 1. COMPILER CACHE (SCCACHE)
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          cache: 'true'

      - name: Install OpenBLAS
        shell: powershell
        run: |
          cmd /c "C:\msys64\usr\bin\pacman.exe -S --noconfirm mingw-w64-x86_64-openblas"
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # 2. VCPKG CACHE & INSTALL
      - name: Restore vcpkg Cache
        id: vcpkg-cache
        uses: actions/cache@v3
        with:
          path: vcpkg
          key: ${{ runner.os }}-vcpkg-ninja-${{ hashFiles('app/vcpkg.json') }}

      - name: Setup & Install vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
          cd $env:GITHUB_WORKSPACE\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

      # 3. LLAMA ENGINE CACHING (⚡ MAJOR SPEEDUP)
      - name: Get Llama Commit Hash
        id: llama-hash
        shell: bash
        run: echo "hash=$(git submodule status app/vendor/llama.cpp | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Cache Llama Build
        id: llama-build-cache
        uses: actions/cache@v3
        with:
          path: build/llama_artifacts
          key: ${{ runner.os }}-llama-build-${{ steps.llama-hash.outputs.hash }}

      - name: Build Llama Engine (Only if changed)
        if: steps.llama-build-cache.outputs.cache-hit != 'true'
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          & app/scripts/build_llama_windows.ps1 `
            -cuda off `
            -vcpkgroot "$env:VCPKG_ROOT" `
            -openblasroot "C:\msys64\mingw64" `
            -extra_cmake_args "-G Ninja -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache"

          # Prepare artifacts for caching
          New-Item -ItemType Directory -Force -Path build/llama_artifacts | Out-Null
          
          # Find and copy llama.dll to artifacts folder
          $dll = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "llama.dll" -Recurse | Select-Object -First 1
          if ($dll) { Copy-Item -Path $dll.FullName -Destination "build/llama_artifacts" -Force }

      # 4. STAGE LLAMA (FROM CACHE OR BUILD)
      - name: Stage Llama DLL
        shell: powershell
        run: |
          # Ninja builds to 'build/', so we put it there
          $destDir = "$env:GITHUB_WORKSPACE\build"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          
          if (Test-Path "build/llama_artifacts/llama.dll") {
             Copy-Item -Path "build/llama_artifacts/llama.dll" -Destination $destDir -Force
             Write-Host "✅ Restored Llama.dll from Cache"
          } else {
             # Fallback if just built
             $dll = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "llama.dll" -Recurse | Select-Object -First 1
             if ($dll) { Copy-Item -Path $dll.FullName -Destination $destDir -Force }
          }

      - name: Create Dummy Precompiled Folders
        shell: powershell
        run: |
          $paths = @("app\lib\precompiled\cpu", "app\lib\precompiled\cuda", "app\lib\precompiled\vulkan")
          foreach ($p in $paths) {
            $f = Join-Path $env:GITHUB_WORKSPACE $p
            if (-not (Test-Path $f)) { New-Item -Path $f -ItemType Directory -Force }
          }

      # 5. CONFIGURE CMAKE (NINJA)
      - name: Configure CMake
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: >
          cmake -B build -S app 
          -G "Ninja"
          -DCMAKE_BUILD_TYPE=Release 
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" 
          -DVCPKG_TARGET_TRIPLET=x64-windows 
          -DWININET_LIB=wininet 
          -DCMAKE_C_COMPILER_LAUNCHER=sccache 
          -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build App
        run: cmake --build build

      - name: Bundle Files
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          mkdir output
          if exist build\*.exe copy build\*.exe output\
          if exist build\llama.dll copy build\llama.dll output\
          windeployqt --release --dir output output\*.exe
          copy "%VCPKG_ROOT%\installed\x64-windows\bin\*.dll" output\
          if exist C:\msys64\mingw64\bin\libopenblas*.dll copy C:\msys64\mingw64\bin\libopenblas*.dll output\
          if exist C:\msys64\mingw64\bin\libgfortran*.dll copy C:\msys64\mingw64\bin\libgfortran*.dll output\
          if exist C:\msys64\mingw64\bin\libgcc*.dll copy C:\msys64\mingw64\bin\libgcc*.dll output\
          if exist C:\msys64\mingw64\bin\libwinpthread*.dll copy C:\msys64\mingw64\bin\libwinpthread*.dll output\

      - name: Upload Finished App
        uses: actions/upload-artifact@v4
        with:
          name: AI-File-Sorter-Gemini
          path: output/*
