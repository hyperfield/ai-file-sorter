name: Build Windows Exe

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Enable GitHub Cache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Install OpenBLAS & Add to Path
        shell: powershell
        run: |
          # Install OpenBLAS
          cmd /c "C:\msys64\usr\bin\pacman.exe -S --noconfirm mingw-w64-x86_64-openblas"
          
          # Add MSYS2 bin to PATH so CMake and scripts can find the DLLs/Headers
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup Local vcpkg
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
          cd $env:GITHUB_WORKSPACE\vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install Support Libraries
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          cd $env:VCPKG_ROOT
          .\vcpkg install curl[ssl] fmt spdlog jsoncpp sqlite3 --triplet x64-windows

      - name: Build Llama Engine
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          # Pass -openblasroot explicitly to ensure it finds the headers
          # We point to C:\msys64\mingw64 where include/ and bin/ live
          & app/scripts/build_llama_windows.ps1 `
            -cuda off `
            -vcpkgroot "$env:VCPKG_ROOT" `
            -openblasroot "C:\msys64\mingw64"

      - name: Debug - Check Llama Output
        shell: powershell
        run: |
          # Verify if the DLL was actually built. If this is empty, the next step fails.
          Write-Host "Checking for llama.dll..."
          Get-ChildItem -Path app\llama\build -Recurse -Filter "llama.dll" | Select-Object FullName

      - name: Configure CMake
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: >
          cmake -B build -S app 
          -DCMAKE_BUILD_TYPE=Release 
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" 
          -DVCPKG_TARGET_TRIPLET=x64-windows 
          -DWININET_LIB=wininet

      - name: Build App (Verbose)
        # Added --verbose to see exactly which copy command is failing
        run: cmake --build build --config Release --verbose

      - name: Bundle Files
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          mkdir output
          
          rem Copy Main App
          if exist build\Release\*.exe copy build\Release\*.exe output\
          
          rem Copy Qt DLLs
          windeployqt --release --dir output output\*.exe
          
          rem Copy Library DLLs
          copy "%VCPKG_ROOT%\installed\x64-windows\bin\*.dll" output\
          
          rem Copy OpenBLAS DLLs
          if exist C:\msys64\mingw64\bin\libopenblas*.dll copy C:\msys64\mingw64\bin\libopenblas*.dll output\
          if exist C:\msys64\mingw64\bin\libgfortran*.dll copy C:\msys64\mingw64\bin\libgfortran*.dll output\
          if exist C:\msys64\mingw64\bin\libgcc*.dll copy C:\msys64\mingw64\bin\libgcc*.dll output\
          if exist C:\msys64\mingw64\bin\libwinpthread*.dll copy C:\msys64\mingw64\bin\libwinpthread*.dll output\

      - name: Upload Finished App
        uses: actions/upload-artifact@v4
        with:
          name: AI-File-Sorter-Gemini
          path: output/*
